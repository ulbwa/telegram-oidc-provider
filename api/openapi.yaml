openapi: 3.0.0

info:
  title: Telegram OIDC Provider API
  version: 0.1.0
  description: API for managing clients and users in the Telegram OIDC Provider

tags:
  - name: public
    description: Public API for browser-based requests (e.g. OIDC endpoints)
  - name: private
    description: Private API for internal use only

components:
  schemas:
    ErrorResponse:
      type: object
      required: [code, error]
      properties:
        code:
          type: string
          enum:
            - INTERNAL
            - INVALID_REQUEST
            - UNAVAILABLE
            - UNAUTHORIZED
            - FORBIDDEN
            - NOT_FOUND
            - BAD_GATEWAY
            - CONFLICT
          description: A short error code
          example: INVALID_REQUEST
        error:
          type: string
          description: A brief error message
          example: Invalid request data
        details:
          description: Additional details about the error
          nullable: true
          oneOf:
            - $ref: "#/components/schemas/ObjectNotFoundDetails"
            - $ref: "#/components/schemas/ConflictDetails"

    ObjectNotFoundDetails:
      type: object
      required: [object]
      properties:
        object:
          type: string
          description: The type of object that was not found
          example: client
        id:
          type: string
          description: The identifier of the object that was not found
          example: "123e456"
          nullable: true

    ConflictDetails:
      type: object
      required: [object]
      properties:
        object:
          type: string
          description: The type of object that was not found
          example: client
        feature:
          type: string
          description: The feature that caused the conflict
          example: redirect_uri

    ClientResponse:
      type: object
      required: [id, name, redirect_uri]
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        redirect_uri:
          type: string
          format: uri

    ClientBriefResponse:
      type: object
      required: [id, name]
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string

    BotResponse:
      type: object
      required: [id, name, username, url]
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        username:
          type: string
        photo_url:
          type: string
          format: url
          nullable: true
        url:
          type: string
          format: url

    BotBriefResponse:
      type: object
      required: [id, name, username]
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        username:
          type: string

paths:
  /clients:
    get:
      tags: [private]
      summary: List all OIDC clients
      parameters:
        - in: query
          name: username
          required: false
          schema:
            type: string
            nullable: true
          description: Filter clients by associated bot's username (case-insensitive, supports partial matches)
          example: "mybot"
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          example: 20
          description: Maximum number of clients to return
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of clients to skip before starting to collect the result set
          example: 0

      responses:
        200:
          description: A list of OIDC clients
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  required: [client, bot]
                  properties:
                    client:
                      $ref: "#/components/schemas/ClientBriefResponse"
                    bot:
                      $ref: "#/components/schemas/BotBriefResponse"

    post:
      tags: [private]
      summary: Create a new OIDC client
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [client_name, client_redirect_uri, bot_token]
              properties:
                client_name:
                  type: string
                  minLength: 5
                  maxLength: 100
                  description: The name of the OIDC client
                  example: "My OIDC Client"
                client_redirect_uri:
                  type: string
                  format: uri
                  description: The redirect URI for the OIDC client
                  example: "https://example.com/callback"
                bot_token:
                  type: string
                  minLength: 37
                  description: Telegram bot token for the client
                  example: "123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11"

      responses:
        201:
          description: Client created successfully
          content:
            application/json:
              schema:
                type: object
                required: [credentials]
                properties:
                  credentials:
                    type: object
                    required: [client_id, client_secret]
                    properties:
                      client_id:
                        type: string
                        format: uuid
                      client_secret:
                        type: string
                        example: "some very secret value"

  /clients/{client_id}:
    get:
      tags: [private]
      summary: Get details of an OIDC client
      parameters:
        - in: path
          name: client_id
          required: true
          schema:
            type: string
            format: uuid
          description: The unique identifier of the OIDC client

      responses:
        200:
          description: Client details retrieved successfully
          content:
            application/json:
              schema:
                type: object
                required: [client, bot]
                properties:
                  client:
                    $ref: "#/components/schemas/ClientResponse"
                  bot:
                    $ref: "#/components/schemas/BotResponse"

    patch:
      tags: [private]
      summary: Update details of an OIDC client
      parameters:
        - in: path
          name: client_id
          required: true
          schema:
            type: string
            format: uuid
          description: The unique identifier of the OIDC client

      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [client_name, client_redirect_uri, bot_token]
              properties:
                client_name:
                  type: string
                  minLength: 5
                  maxLength: 100
                  description: The name of the OIDC client
                  example: "My OIDC Client"
                client_redirect_uri:
                  type: string
                  format: uri
                  description: The redirect URI for the OIDC client
                  example: "https://example.com/callback"
                bot_token:
                  type: string
                  minLength: 37
                  description: Telegram bot token for the client
                  example: "123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11"

      responses:
        200:
          description: Client updated successfully
          content:
            application/json:
              schema:
                type: object
                required: [credentials]
                properties:
                  credentials:
                    type: object
                    required: [client_id, client_secret]
                    properties:
                      client_id:
                        type: string
                        format: uuid
                      client_secret:
                        type: string
                        example: "some very secret value"

  /login:
    get:
      tags: [private]
      summary: Get login information for a login challenge
      parameters:
        - in: query
          name: login_challenge
          required: true
          description: Unique login request identifier issued by ORY Hydra.
          schema:
            type: string

      responses:
        200:
          description: Login information retrieved successfully
          content:
            application/json:
              schema:
                type: object
                required: [client_name, redirect_hostname, bot_username, skip]
                properties:
                  client_name:
                    type: string
                  redirect_hostname:
                    type: string
                    format: hostname
                  bot_username:
                    type: string
                  skip:
                    type: boolean

  /login/reject:
    get:
      tags: [public]
      summary: Reject a login challenge
      parameters:
        - in: query
          name: login_challenge
          required: true
          description: Unique login request identifier issued by ORY Hydra.
          schema:
            type: string
        - in: query
          name: cause
          required: true
          schema:
            type: string
            enum: [change_account, cancel]

      responses:
        203:
          description: Login flow processed. The client must follow the URL provided in the Location header.
          headers:
            Location:
              description: >
                Redirect URL generated by ORY Hydra.
                The client must redirect the user to this URL to continue
                the OIDC flow. It may contain either success parameters
                or error parameters.
              schema:
                type: string
                format: uri

  /login/skip:
    get:
      tags: [public]
      summary: Skip login and accept the login challenge directly
      parameters:
        - in: query
          name: login_challenge
          required: true
          description: Unique login request identifier issued by ORY Hydra.
          schema:
            type: string

      responses:
        203:
          description: Login flow processed. The client must follow the URL provided in the Location header.
          headers:
            Location:
              description: >
                Redirect URL generated by ORY Hydra.
                The client must redirect the user to this URL to continue
                the OIDC flow. It may contain either success parameters
                or error parameters.
              schema:
                type: string
                format: uri

  /login/widget:
    get:
      tags: [public]
      summary: Login user by telegram widget auth data
      parameters:
        - in: query
          name: login_challenge
          required: true
          description: Unique login request identifier issued by ORY Hydra.
          schema:
            type: string
        - in: query
          name: telegram_widget_auth_data
          required: true
          description: >
            Collection of parameters returned by the Telegram Login Widget.
            Passed as form-style query parameters (explode=true), for example:
              - id
              - first_name
              - last_name
              - username
              - photo_url
              - auth_date
              - hash

            The server must:
              1. Verify the signature (hash) according to Telegramâ€™s algorithm.
              2. Validate auth_date freshness.
              3. Accept or reject the login request via ORY Hydra.
          schema:
            type: object
            additionalProperties: true
          style: form
          explode: true

      responses:
        203:
          description: Login flow processed. The client must follow the URL provided in the Location header.
          headers:
            Location:
              description: >
                Redirect URL generated by ORY Hydra.
                The client must redirect the user to this URL to continue
                the OIDC flow. It may contain either success parameters
                or error parameters.
              schema:
                type: string
                format: uri

  /login/miniapp:
    get:
      tags: [public]
      summary: Login user via Telegram Mini App init data

      parameters:
        - in: query
          name: login_challenge
          required: true
          description: Unique login request identifier issued by ORY Hydra.
          schema:
            type: string
        - in: query
          name: telegram_mini_app_auth_data
          required: true
          description: >
            Collection of key-value query parameters returned by the Telegram Mini App.
            Passed as URL-encoded form-style query parameters (explode=true),
            for example:
              - id
              - first_name
              - last_name
              - username
              - photo_url
              - auth_date
              - hash

            The server must:
              1. Parse and validate each field.
              2. Verify the hash signature using the bot token.
              3. Validate auth_date freshness.
              4. Accept or reject the login request via ORY Hydra.
          schema:
            type: object
            additionalProperties: true
          style: form
          explode: true

      responses:
        203:
          description: Login flow processed. The client must follow the URL provided in the Location header.
          headers:
            Location:
              description: >
                Redirect URL generated by ORY Hydra.
                The client must redirect the user to this URL to continue
                the OIDC flow. It may contain either success parameters
                or error parameters.
              schema:
                type: string
                format: uri

  /consent:
    get:
      tags: [private]
      summary: Get consent information for a consent challenge
      parameters:
        - in: query
          name: consent_challenge
          required: true
          description: Unique consent request identifier issued by ORY Hydra.
          schema:
            type: string

      responses:
        200:
          description: Consent information retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  client_name:
                    type: string
                  redirect_hostname:
                    type: string
                    format: hostname
                  bot_username:
                    type: string
                  skip:
                    type: boolean
